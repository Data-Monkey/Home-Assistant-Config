
################################################################
## Install Instructions
################################################################
##
##  1. Enable MQTT using your preferred MQTT broker
##     https://home-assistant.io/components/mqtt/
##
##  2. Enable MQTT Discovery by adding `discovery: true` and
##     `discovery_prefix: homeassistant` under the `mqtt:` section
##     of your configuration.yaml
##
##     mqtt:
##       discovery: true
##       discovery_prefix: homeassistant
##
##  3. Save this file as CONFIGDIR/packages/battery_alert.yaml
##
##  4. Add `packages: !include_dir_named packages` under the
##     `homeassistant:` section of your configuration.yaml
##
##     homeassistant:
##       packages: !include_dir_named packages
##
##  5. Restart Home Assistant
##
################################################################


################################################
## Automation
################################################

- alias: device_sensor
  initial_state: 'on'
  trigger:
    - platform: event
      event_type: state_changed
  condition:
    - condition: template
      value_template: "{{ trigger.event.data is not none }}"
    - condition: template
      value_template: "{{ trigger.event.data.old_state is not none }}"
    - condition: template
      value_template: "{{ trigger.event.data.new_state is not none }}"
    - condition: template
      value_template: "{{ trigger.event.data.new_state.attributes is not none }}"
    - condition: template
      value_template: "{{ trigger.event.data.new_state.domain=='device_tracker' }}"
  action:
    - service: mqtt.publish
      data_template:
        topic: "homeassistant/sensor/device_{{ trigger.event.data.new_state.object_id }}/config"
        retain: false
        payload: &config_payload >-
          {
            "name": "{{ trigger.event.data.new_state.name }}",
            "state_topic": "homeassistant/sensor/device_{{ trigger.event.data.new_state.object_id }}/state",
            "unique_id": "device_{{ trigger.event.data.new_state.object_id }}"
          }
    - service: mqtt.publish
      data_template:
        topic: "homeassistant/sensor/device_{{ trigger.event.data.new_state.object_id }}/state"
        retain: false
        payload: "{% if trigger.event.data.new_state.state == 'home' %} Online {% else %} Offline {% endif %}"
          

